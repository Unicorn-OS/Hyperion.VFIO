# works:
# - https://github.com/FilBot3/fedora-silverblue-gpu-passthrough

- debug:
    msg: "Home: {{ log_finished }}"

- name: Remove old devices
  ansible.builtin.shell: >
    rpm-ostree kargs
    --delete-if-present="vfio-pci.ids"
  args:
    creates: "{{ log_blacklist }}"
  when: overwrite_pciids
  become: true

#---
- name: Preliminary Checks
  ansible.builtin.shell: >
    rpm-ostree kargs
    --delete-if-present=rd.driver.blacklist=nouveau
    --delete-if-present=modprobe.blacklist=nouveau
    --delete-if-present=nvidia-drm.modeset=1
  args:
    creates: "{{ log_pre }}"
  notify:
  - Log pre
  - Reboot
  become: true

- name: Ensure CPU has IOMMU enabled
  ansible.builtin.shell: >
    rpm-ostree kargs
    --append-if-missing="{{ iommu_type }}=on"
    --append-if-missing="iommu=pt"
    --append-if-missing="rd.driver.pre=vfio_pci"
  args:
    creates: "{{ log_iommu }}"
  notify:
  - Log iommu
  - Reboot
  become: true

- name: Blacklist PCI devices!
  ansible.builtin.shell: >
    rpm-ostree kargs
    --append-if-missing="vfio-pci.ids={{ vfio_pci_string }}"
  args:
    creates: "{{ log_blacklist }}"
  notify:
  - Log blacklist
  - Reboot
  become: true

# Use Replace instead:
# rpm-ostree kargs --replace=KEY=VALUE=NEWVALUE

- name: perform a dracut to make sure the initramfs has the Kernel module loaded
  ansible.builtin.shell: >
    rpm-ostree initramfs
    --enable
    --arg="--add-drivers"
    --arg="vfio-pci"
  args:
    creates: "{{ log_finished }}"
  notify:
  - Log finished
  - Reboot
  become: true